<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >	
<mapper namespace="project06.repository.pmsempRep">
 	<resultMap type="pmsemp" id="pmsempResult"/>
 	<!-- CEO, CTO 사원리스트 불러오기 -->
 	<select id="pmsempList" resultMap="pmsempResult" parameterType="pmsemp">
		SELECT a.eno, a.name, a.GRADE, a.DEPT, a.EMAIL, a.PHONE,  
		(select c.CNAME from pmsmember b, pmscodes c where a.eno=b.mno and b.mdiv=c.cno) cname 
		FROM pmsemp a 
		WHERE NOT a.grade LIKE '%'||'대표이사'||'%'
 	</select>	
 	<!-- 상세페이지 -->
 	<select id="getemp" resultType="pmsemp" parameterType="int">
	 	SELECT a.eno, a.name, a.GRADE, a.DEPT, a.EMAIL, a.PHONE,  
			c.CNAME,b.pno
			FROM pmsemp a, pmsmember b, pmscodes c
			WHERE b.mdiv=c.cno(+)
			AND a.eno = b.mno(+)
			AND a.eno = #{eno}
 	</select>
 	<!-- 프로젝트 리스트 -->
 	<select id="getPlist" resultMap="pmsEmpEnoResult">
		select pno 
		from pmsproject
		order by pno asc 
	</select>
 	<!-- pmsmember에 등록 됐는지 확인 -->
 	<select id="memCheck" resultType="int" parameterType="pmsemp">
		select count(*) 
		from pmsmember 
		where mno=#{eno}
	</select>
	<!-- pms에 등록안된 경우 CTO로등록 -->
	<insert id="insertMem1" parameterType="pmsemp">
		 insert into pmsmember 
		 	values(#{eno}, #{pass}, 3, #{phone}, null)
	</insert>
 	<!-- 기존 CTO 권한변경 -->
	<update id="updatepmsemp2" parameterType="pmsemp">
		UPDATE pmsmember
		SET mdiv=9
		WHERE mdiv=3
	</update>
 	<!-- CTO설정 -->
	<update id="updatepmsemp1" parameterType="pmsemp">
		UPDATE pmsmember
		SET mdiv=3
		WHERE mno=#{eno}
	</update>
	<!-- pms에 등록안된 경우 PM으로등록 -->
	<insert id="insertMem2" parameterType="pmsemp">
		 insert into pmsmember 
		 	values(#{eno}, #{pass}, 4, #{phone}, #{pno})
	</insert>
	<!-- PM 권한해제 설정 -->
	<update id="updatePm2" parameterType="pmsemp">
		UPDATE pmsmember
		SET mdiv=9, pno=null
		WHERE mdiv=4
		and pno=#{pno}
	</update>
	<!-- PM 권한 설정  -->
	<update id="updatePm1" parameterType="pmsemp">
		UPDATE pmsmember
		SET mdiv=4, pno=#{pno}
		WHERE mno=#{eno}
	</update>
 	<!-- PM 팀원 추가 리스트 -->
 	<select id="insList" resultMap="pmsempResult" parameterType="pmsemp">
		SELECT *
FROM (
SELECT a.eno, a.name, a.GRADE, a.DEPT, a.EMAIL, a.PHONE,  
		c.CNAME,b.pno
		FROM pmsemp a, pmsmember b, pmscodes c
		WHERE a.eno = b.mno and b.mdiv=c.cno
		AND c.cno =9 
		AND b.pno is NULL
		UNION ALL
		select a.eno, a.name, a.GRADE, a.DEPT, a.EMAIL, a.PHONE,  
				c.CNAME,b.pno
		from (pmsemp a left outer join pmsMember b on a.eno=b.mno), pmscodes c
		where b.mno is NULL AND c.cno=9)
		ORDER BY eno ASC
 	</select>
 	<!-- pms등록된 직원 팀원추가 -->
 	<update id="updPNum" parameterType="pmsemp">
		UPDATE pmsmember
		SET pno=#{pno}, mdiv=5
		WHERE mno =#{eno}
	</update>	
 	<!-- pms등록안된 직원 팀원추가 -->
 	<insert id="insPNum" parameterType="pmsemp">
		 insert into pmsmember 
		 	values(#{eno}, #{pass}, 5, #{phone}, #{pno})
	</insert>
 	<!-- pm 프로젝트 팀원 삭제 리스트 -->
 	<select id="pmempList" resultMap="pmsempResult" parameterType="pmsemp">
		SELECT a.eno, a.name, a.GRADE, a.DEPT, a.EMAIL, a.PHONE,  
		c.CNAME,b.pno
		FROM pmsemp a, pmsmember b, pmscodes c
		WHERE a.eno = b.mno and b.mdiv=c.cno
		AND b.pno=#{pno}
		AND b.mdiv=5
 	</select>
	<!-- 팀원삭제  pno==>null로 변경 -->
	<update id="delemp" parameterType="pmsemp">
		UPDATE pmsmember
		SET pno=null, mdiv=9
		WHERE mno =#{eno}
	</update>	
	<!-- 인사 사원정보 수정 페이지 -->
	<select id="getPmsemp" resultType="pmsemp" parameterType="int">
 		SELECT *
 		FROM pmsemp
 		WHERE eno = #{eno}
 	</select>
	<!-- 사원정보 수정 -->
	<update id="updateEmp" parameterType="pmsemp">
	UPDATE pmsemp
		SET dept =#{dept}, grade =#{grade}
		WHERE eno =#{eno}
	</update>
	<!-- 퇴사처리 -->
	<!-- pms등록된 직원 -->
	<update id="delGrade1" parameterType="pmsemp">
		UPDATE pmsemp
			SET grade = '퇴사', dept = null
			WHERE eno =#{eno}
	</update>
	<update id="delGrade2" parameterType="pmsemp">
		UPDATE pmsmember
			SET mdiv = 8 , pno = null
			WHERE mno =#{eno}
	</update>
	<!-- pms등록 안된 직원 -->
	<delete id="delGrade3" parameterType="pmsemp">
		delete from pmsemp
			WHERE eno =#{eno}
	</delete>
	<!-- 사원등록 -->
	<insert id="insert" parameterType="pmsemp">
		 insert into pmsemp values(pmsemp_seq.nextval,#{name},#{dept},
		 					#{grade},#{phone},#{email})
	</insert>
	
	
	
	
<!-- Jin -->
	<resultMap type="int" id="pmsEmpEnoResult"/>
	<select id="pmsEmpCounter" resultType="int" parameterType="int">
 		SELECT count(*) FROM pmsemp WHERE name=#{name} AND email=#{email}
 	</select>
 	
	<select id="pmsEmpEno" resultMap="pmsEmpEnoResult" parameterType="int">
		SELECT eno FROM pmsemp WHERE name=#{name} AND email=#{email}
	</select>

<!-- Jin -->
	<resultMap type="int" id="pmsEmpPassResult"/>
	<select id="pmsEmpPassCounter" resultType="int" parameterType="int">
 		SELECT count(*) FROM pmsemp WHERE eno=#{eno} AND name=#{name} AND email=#{email}
 	</select>	
	<select id="pmsEmpPass" resultMap="pmsEmpPassResult" parameterType="int">
		SELECT eno FROM pmsemp WHERE eno=#{eno} AND name=#{name} AND email=#{email}
	</select>
	
	
	
</mapper>	